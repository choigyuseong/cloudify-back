### spotify ì‚¬ìš©ìë¥¼ ìœ„í•œ idã€secret ë“±ë¡

# Spotify API ì„¤ì •
spotify.client-id=YOUR_SPOTIFY_CLIENT_ID
spotify.client-secret=YOUR_SPOTIFY_CLIENT_SECRET

# ì„œë²„ ì„¤ì •
server.port=8080

# ë¡œê¹…
logging.level.org.example=DEBUG



ï¼ƒï¼ƒï¼ƒspotify ì„œë²„ì™€ í†µì‹ ì‹œ ì‚¬ìš©###
package org.example.apispring.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.reactive.function.client.WebClient;

@Configuration
public class WebClientConfig {
    
    @Bean
    public WebClient.Builder webClientBuilder() {
        return WebClient.builder();
    }
}



###ì¸ì¦###

package org.example.apispring.service;

import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;
import org.springframework.web.reactive.function.client.WebClient;

import java.time.Instant;
import java.util.Base64;
import java.util.Map;

@Service
@Slf4j
public class SpotifyAuthService {
    
    @Value("${spotify.client-id}")
    private String clientId;
    
    @Value("${spotify.client-secret}")
    private String clientSecret;
    
    private final WebClient webClient;
    
    private String accessToken;
    private Instant tokenExpiry;
    
    public SpotifyAuthService(WebClient.Builder webClientBuilder) {
        this.webClient = webClientBuilder
                .baseUrl("https://accounts.spotify.com")
                .build();
    }
    
    /**
     * Access Token ë°œê¸‰ (ìë™ ê°±ì‹  í¬í•¨)
     */
    public String getAccessToken() {
        // í† í°ì´ ì—†ê±°ë‚˜ ë§Œë£Œ 5ë¶„ ì „ì´ë©´ ê°±ì‹ 
        if (accessToken == null || 
            tokenExpiry == null || 
            Instant.now().isAfter(tokenExpiry.minusSeconds(300))) {
            
            refreshAccessToken();
        }
        
        return accessToken;
    }
    
    /**
     * Access Token ê°±ì‹ 
     */
    private void refreshAccessToken() {
        log.info("ğŸ”„ Spotify Access Token ê°±ì‹  ì¤‘...");
        
        try {
            // Basic Auth ì¸ì½”ë”©
            String auth = clientId + ":" + clientSecret;
            String encodedAuth = Base64.getEncoder()
                    .encodeToString(auth.getBytes());
            
            // Request Body
            MultiValueMap<String, String> formData = new LinkedMultiValueMap<>();
            formData.add("grant_type", "client_credentials");
            
            // API í˜¸ì¶œ
            Map<String, Object> response = webClient.post()
                    .uri("/api/token")
                    .header("Authorization", "Basic " + encodedAuth)
                    .header("Content-Type", "application/x-www-form-urlencoded")
                    .bodyValue(formData)
                    .retrieve()
                    .bodyToMono(Map.class)
                    .block();
            
            // í† í° ì €ì¥
            this.accessToken = (String) response.get("access_token");
            Integer expiresIn = (Integer) response.get("expires_in");
            this.tokenExpiry = Instant.now().plusSeconds(expiresIn);
            
            log.info("âœ… Access Token ë°œê¸‰ ì™„ë£Œ (ë§Œë£Œ: {})", tokenExpiry);
            
        } catch (Exception e) {
            log.error("âŒ Access Token ë°œê¸‰ ì‹¤íŒ¨", e);
            throw new RuntimeException("Spotify ì¸ì¦ ì‹¤íŒ¨", e);
        }
    }
}



ï¼ƒï¼ƒï¼ƒíŠ¸ë™ê²€ìƒ‰ï¼ƒï¼ƒï¼ƒ
package org.example.apispring.service;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.example.apispring.dto.SpotifyTrack;
import org.springframework.stereotype.Service;
import org.springframework.web.reactive.function.client.WebClient;
import org.springframework.web.util.UriComponentsBuilder;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;

@Service
@RequiredArgsConstructor
@Slf4j
public class SpotifySearchService {
    
    private final SpotifyAuthService authService;
    private final WebClient.Builder webClientBuilder;
    
    private WebClient getSpotifyClient() {
        return webClientBuilder
                .baseUrl("https://api.spotify.com/v1")
                .build();
    }
    
    /**
     * íŠ¸ë™ ê²€ìƒ‰
     */
    public List<SpotifyTrack> searchTracks(String query, int limit) {
        log.info("ğŸ” Spotify ê²€ìƒ‰: {}", query);
        
        String token = authService.getAccessToken();
        
        String uri = UriComponentsBuilder.fromPath("/search")
                .queryParam("q", query)
                .queryParam("type", "track")
                .queryParam("market", "KR")
                .queryParam("limit", limit)
                .build()
                .toUriString();
        
        try {
            Map<String, Object> response = getSpotifyClient()
                    .get()
                    .uri(uri)
                    .header("Authorization", "Bearer " + token)
                    .retrieve()
                    .bodyToMono(Map.class)
                    .block();
            
            // íŒŒì‹±
            Map<String, Object> tracks = (Map<String, Object>) response.get("tracks");
            List<Map<String, Object>> items = (List<Map<String, Object>>) tracks.get("items");
            
            List<SpotifyTrack> result = new ArrayList<>();
            for (Map<String, Object> item : items) {
                SpotifyTrack track = parseTrack(item);
                result.add(track);
            }
            
            log.info("âœ… ê²€ìƒ‰ ì™„ë£Œ: {}ê°œ", result.size());
            return result;
            
        } catch (Exception e) {
            log.error("âŒ ê²€ìƒ‰ ì‹¤íŒ¨", e);
            throw new RuntimeException("Spotify ê²€ìƒ‰ ì‹¤íŒ¨", e);
        }
    }
    
    /**
     * ë‹¨ì¼ íŠ¸ë™ ì¡°íšŒ
     */
    public SpotifyTrack getTrack(String trackId) {
        log.info("ğŸµ íŠ¸ë™ ì¡°íšŒ: {}", trackId);
        
        String token = authService.getAccessToken();
        
        try {
            Map<String, Object> response = getSpotifyClient()
                    .get()
                    .uri("/tracks/" + trackId)
                    .header("Authorization", "Bearer " + token)
                    .retrieve()
                    .bodyToMono(Map.class)
                    .block();
            
            return parseTrack(response);
            
        } catch (Exception e) {
            log.error("âŒ íŠ¸ë™ ì¡°íšŒ ì‹¤íŒ¨", e);
            throw new RuntimeException("íŠ¸ë™ ì¡°íšŒ ì‹¤íŒ¨", e);
        }
    }
    
    /**
     * JSON â†’ SpotifyTrack ë³€í™˜
     */
    private SpotifyTrack parseTrack(Map<String, Object> item) {
        SpotifyTrack track = new SpotifyTrack();
        
        track.setId((String) item.get("id"));
        track.setName((String) item.get("name"));
        track.setDurationMs((Integer) item.get("duration_ms"));
        track.setPopularity((Integer) item.get("popularity"));
        
        // ì•„í‹°ìŠ¤íŠ¸
        List<Map<String, Object>> artists = (List<Map<String, Object>>) item.get("artists");
        if (!artists.isEmpty()) {
            Map<String, Object> artist = artists.get(0);
            track.setArtistId((String) artist.get("id"));
            track.setArtistName((String) artist.get("name"));
        }
        
        // ì•¨ë²”
        Map<String, Object> album = (Map<String, Object>) item.get("album");
        track.setAlbumName((String) album.get("name"));
        
        return track;
    }
}



ï¼ƒï¼ƒï¼ƒì˜¤ë””ì–´ í”¼ì²˜ï¼ƒï¼ƒï¼ƒ

package org.example.apispring.service;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.example.apispring.dto.AudioFeatures;
import org.springframework.stereotype.Service;
import org.springframework.web.reactive.function.client.WebClient;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;

@Service
@RequiredArgsConstructor
@Slf4j
public class SpotifyAudioFeaturesService {
    
    private final SpotifyAuthService authService;
    private final WebClient.Builder webClientBuilder;
    
    private WebClient getSpotifyClient() {
        return webClientBuilder
                .baseUrl("https://api.spotify.com/v1")
                .build();
    }
    
    /**
     * ì˜¤ë””ì˜¤ í”¼ì²˜ ê°€ì ¸ì˜¤ê¸° (ë°°ì¹˜)
     */
    public List<AudioFeatures> getAudioFeatures(List<String> trackIds) {
        log.info("ğŸ¼ ì˜¤ë””ì˜¤ í”¼ì²˜ ì¡°íšŒ: {}ê°œ", trackIds.size());
        
        String token = authService.getAccessToken();
        String ids = String.join(",", trackIds);
        
        try {
            Map<String, Object> response = getSpotifyClient()
                    .get()
                    .uri("/audio-features?ids=" + ids)
                    .header("Authorization", "Bearer " + token)
                    .retrieve()
                    .bodyToMono(Map.class)
                    .block();
            
            List<Map<String, Object>> features = 
                    (List<Map<String, Object>>) response.get("audio_features");
            
            List<AudioFeatures> result = new ArrayList<>();
            for (Map<String, Object> feature : features) {
                if (feature != null) {
                    AudioFeatures af = parseAudioFeatures(feature);
                    result.add(af);
                }
            }
            
            log.info("âœ… ì˜¤ë””ì˜¤ í”¼ì²˜ ì¡°íšŒ ì™„ë£Œ: {}ê°œ", result.size());
            return result;
            
        } catch (Exception e) {
            log.error("âŒ ì˜¤ë””ì˜¤ í”¼ì²˜ ì¡°íšŒ ì‹¤íŒ¨", e);
            throw new RuntimeException("ì˜¤ë””ì˜¤ í”¼ì²˜ ì¡°íšŒ ì‹¤íŒ¨", e);
        }
    }
    
    /**
     * JSON â†’ AudioFeatures ë³€í™˜
     */
    private AudioFeatures parseAudioFeatures(Map<String, Object> data) {
        AudioFeatures af = new AudioFeatures();
        
        af.setId((String) data.get("id"));
        af.setTempo(getDouble(data.get("tempo")));
        af.setEnergy(getDouble(data.get("energy")));
        af.setValence(getDouble(data.get("valence")));
        af.setDanceability(getDouble(data.get("danceability")));
        af.setAcousticness(getDouble(data.get("acousticness")));
        af.setInstrumentalness(getDouble(data.get("instrumentalness")));
        
        return af;
    }
    
    private Double getDouble(Object value) {
        if (value == null) return null;
        if (value instanceof Double) return (Double) value;
        if (value instanceof Integer) return ((Integer) value).doubleValue();
        return Double.parseDouble(value.toString());
    }
}




ï¼ƒï¼ƒï¼ƒíƒœê·¸ìƒì„±ï¼ƒï¼ƒï¼ƒ

package org.example.apispring.service;

import lombok.extern.slf4j.Slf4j;
import org.example.apispring.dto.AudioFeatures;
import org.example.apispring.dto.GeneratedTags;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;

@Service
@Slf4j
public class TagGenerationService {
    
    /**
     * ì˜¤ë””ì˜¤ í”¼ì²˜ë¡œ íƒœê·¸ ìƒì„±
     */
    public GeneratedTags generateTags(AudioFeatures features) {
        log.info("ğŸ·ï¸  íƒœê·¸ ìƒì„± ì¤‘: {}", features.getId());
        
        GeneratedTags tags = new GeneratedTags();
        tags.setTrackId(features.getId());
        
        // TEMPO íƒœê·¸
        String tempoTag = generateTempoTag(features.getTempo());
        if (tempoTag != null) {
            tags.addTag("TEMPO", tempoTag);
        }
        
        // MOOD íƒœê·¸
        List<String> moodTags = generateMoodTags(features);
        for (String mood : moodTags) {
            tags.addTag("MOOD", mood);
        }
        
        // BRANCH íƒœê·¸
        String branchTag = generateBranchTag(features);
        if (branchTag != null) {
            tags.addTag("BRANCH", branchTag);
        }
        
        // ACTIVITY íƒœê·¸
        List<String> activityTags = generateActivityTags(features);
        for (String activity : activityTags) {
            tags.addTag("ACTIVITY", activity);
        }
        
        log.info("âœ… íƒœê·¸ ìƒì„± ì™„ë£Œ: {}", tags.getAllTags());
        return tags;
    }
    
    /**
     * TEMPO íƒœê·¸ ìƒì„±
     */
    private String generateTempoTag(Double bpm) {
        if (bpm == null) return null;
        
        if (bpm < 90) return "tempo.slow";
        if (bpm <= 120) return "tempo.mid";
        return "tempo.fast";
    }
    
    /**
     * MOOD íƒœê·¸ ìƒì„±
     */
    private List<String> generateMoodTags(AudioFeatures features) {
        List<String> moods = new ArrayList<>();
        
        Double energy = features.getEnergy();
        Double valence = features.getValence();
        
        if (energy == null || valence == null) {
            return moods;
        }
        
        // energy < 0.40 & valence â‰¥ 0.50 â†’ comfort/tender
        if (energy < 0.40 && valence >= 0.50) {
            moods.add("mood.comfort");
        }
        
        // energy < 0.40 & valence < 0.50 â†’ calm/wistful
        if (energy < 0.40 && valence < 0.50) {
            moods.add("mood.calm");
        }
        
        // energy â‰¥ 0.60 & valence â‰¥ 0.60 â†’ uplift
        if (energy >= 0.60 && valence >= 0.60) {
            moods.add("mood.uplift");
        }
        
        // instrumentalness â‰¥ 0.60 â†’ focus
        if (features.getInstrumentalness() != null && 
            features.getInstrumentalness() >= 0.60) {
            moods.add("mood.focus");
        }
        
        return moods;
    }
    
    /**
     * BRANCH íƒœê·¸ ìƒì„±
     */
    private String generateBranchTag(AudioFeatures features) {
        Double energy = features.getEnergy();
        Double tempo = features.getTempo();
        
        if (energy == null || tempo == null) {
            return null;
        }
        
        // energy < 0.55 & bpm < 115 â†’ calm
        if (energy < 0.55 && tempo < 115) {
            return "branch.calm";
        }
        
        // energy â‰¥ 0.55 or bpm â‰¥ 115 â†’ uplift
        if (energy >= 0.55 || tempo >= 115) {
            return "branch.uplift";
        }
        
        return null;
    }
    
    /**
     * ACTIVITY íƒœê·¸ ìƒì„±
     */
    private List<String> generateActivityTags(AudioFeatures features) {
        List<String> activities = new ArrayList<>();
        
        Double bpm = features.getTempo();
        Double energy = features.getEnergy();
        Double instrumentalness = features.getInstrumentalness();
        Double danceability = features.getDanceability();
        
        if (bpm == null || energy == null) {
            return activities;
        }
        
        // study/focus: 60â‰¤bpmâ‰¤100 & energy<0.5 & instrumentalnessâ‰¥0.5
        if (bpm >= 60 && bpm <= 100 && 
            energy < 0.5 && 
            instrumentalness != null && instrumentalness >= 0.5) {
            activities.add("activity.study");
        }
        
        // workout: bpm>120 & energyâ‰¥0.7 & danceabilityâ‰¥0.6
        if (bpm > 120 && 
            energy >= 0.7 && 
            danceability != null && danceability >= 0.6) {
            activities.add("activity.workout");
        }
        
        // unwind: 70â‰¤bpmâ‰¤110 & energy<0.5
        if (bpm >= 70 && bpm <= 110 && energy < 0.5) {
            activities.add("activity.unwind");
        }
        
        return activities;
    }
}
