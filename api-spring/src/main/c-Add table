// ==================== 3. Spotify API (spotify.js) ====================
// Spotifyì—ì„œ ê³¡ ê²€ìƒ‰

const axios = require('axios');
const config = require('./1_config');
const { sleep } = require('./2_utils');

async function getSpotifyAccessToken() {
  try {
    console.log('ğŸµ Spotify í† í° ìš”ì²­ ì¤‘...');
    
    if (config.spotifyAccessToken() && Date.now() < config.spotifyTokenExpiry()) {
      console.log('âœ… ê¸°ì¡´ í† í° ì‚¬ìš©');
      return config.spotifyAccessToken();
    }

    const response = await axios.post(
      'https://accounts.spotify.com/api/token',
      'grant_type=client_credentials',
      {
        headers: {
          'Authorization': 'Basic ' + Buffer.from(
            config.SPOTIFY_CLIENT_ID + ':' + config.SPOTIFY_CLIENT_SECRET
          ).toString('base64'),
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        timeout: 10000
      }
    );

    config.setSpotifyAccessToken(response.data.access_token);
    config.setSpotifyTokenExpiry(Date.now() + (response.data.expires_in * 1000) - 60000);
    
    console.log('âœ… Spotify Access Token ë°œê¸‰ ì™„ë£Œ');
    return response.data.access_token;
  } catch (error) {
    console.error('âŒ Spotify Token ë°œê¸‰ ì‹¤íŒ¨:', error.message);
    throw error;
  }
}

async function searchGenreTracks(genre, limit = 20) {
  try {
    const token = await getSpotifyAccessToken();
    
    console.log(`\nğŸµ "${genre}" ì¥ë¥´ì—ì„œ ${limit}ê³¡ ê²€ìƒ‰ ì¤‘...\n`);
    
    const queries = [
      `genre:"${genre}"`,
      `genre:${genre}`,
      `genre:${genre} tag:highly_relevant`
    ];
    
    let response = null;
    for (const query of queries) {
      try {
        response = await axios.get('https://api.spotify.com/v1/search', {
          params: { 
            q: query, 
            type: 'track', 
            limit: limit,
            market: 'US'
          },
          headers: { 'Authorization': `Bearer ${token}` },
          timeout: 10000
        });
        
        if (response.data.tracks.items.length > 0) {
          console.log(`  âœ… "${query}"ë¡œ ${response.data.tracks.items.length}ê°œ ê³¡ ê²€ìƒ‰ ì™„ë£Œ`);
          break;
        }
      } catch (e) {
        console.error(`  âš ï¸ "${query}" ê²€ìƒ‰ ì‹¤íŒ¨:`, e.message);
        continue;
      }
    }

    if (!response || response.data.tracks.items.length === 0) {
      console.log('  âš ï¸ ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ');
      return [];
    }

    const uniqueTracks = new Map();
    response.data.tracks.items
      .sort((a, b) => b.popularity - a.popularity)
      .forEach(track => {
        if (!uniqueTracks.has(track.id)) {
          uniqueTracks.set(track.id, {
            id: track.id,
            name: track.name,
            artists: track.artists.map(a => a.name),
            popularity: track.popularity,
            duration_ms: track.duration_ms,
            genre: genre,
            explicit: track.explicit
          });
        }
      });

    const tracks = Array.from(uniqueTracks.values()).slice(0, limit);
    
    console.log(`  ğŸ“Š ì„ ë³„ëœ ê³¡ ì •ë³´:`);
    tracks.forEach((t, i) => {
      console.log(`    ${i + 1}. ${t.name} - ${t.artists.join(', ')} (ì¸ê¸°ë„: ${t.popularity})`);
    });

    return tracks;
  } catch (error) {
    console.error(`  âŒ ì¥ë¥´ ê²€ìƒ‰ ì‹¤íŒ¨:`, error.message);
    console.error(`  ìŠ¤íƒ:`, error.stack);
    throw error;
  }
}

async function searchAndGetTrack(query) {
  try {
    const token = await getSpotifyAccessToken();
    
    console.log(`ğŸ” Spotifyì—ì„œ ê²€ìƒ‰ ì¤‘: ${query}`);
    
    const response = await axios.get('https://api.spotify.com/v1/search', {
      params: { q: query, type: 'track', limit: 2 },
      headers: { 'Authorization': `Bearer ${token}` },
      timeout: 10000
    });

    if (response.data.tracks.items.length === 0) {
      console.log('  âš ï¸ ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ');
      return null;
    }

    const candidates = response.data.tracks.items.slice(0, 2);
    
    console.log(`  ğŸ“ ìƒìœ„ ${candidates.length}ê°œ ê²°ê³¼:`);
    candidates.forEach((t, i) => {
      console.log(`    ${i + 1}. ${t.name} - ${t.artists.map(a => a.name).join(', ')}`);
    });

    return candidates;
  } catch (error) {
    console.error('âŒ Spotify ê²€ìƒ‰ ì‹¤íŒ¨:', error.message);
    console.error('ìŠ¤íƒ:', error.stack);
    throw error;
  }
}

module.exports = {
  getSpotifyAccessToken,
  searchGenreTracks,
  searchAndGetTrack
};
