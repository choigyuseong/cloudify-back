// ==================== ì¥ë¥´ë³„ ìˆ˜ì§‘ ====================

app.get('/collect-by-genres', (req, res) => {
  const access_token = req.query.access_token;
  res.send(`
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>ì¥ë¥´ë³„ ê³¡ ìˆ˜ì§‘</title>
      <style>
        body { font-family: Arial; max-width: 1000px; margin: 50px auto; padding: 20px; }
        h1 { color: #1DB954; }
        .genre-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 30px 0; }
        .genre-btn { padding: 20px; background: #1DB954; color: white; text-decoration: none; border-radius: 10px; text-align: center; font-weight: bold; }
        .genre-btn:hover { background: #1ed760; }
      </style>
    </head>
    <body>
      <h1>ğŸµ ì¥ë¥´ë³„ ì¸ê¸° ê³¡ ëŒ€ëŸ‰ ìˆ˜ì§‘</h1>
      <p>ê° ì¥ë¥´ë³„ë¡œ ì¸ê¸° ê³¡ 50ê°œì”© ìˆ˜ì§‘í•©ë‹ˆë‹¤</p>
      <div class="genre-grid">
        <a href="/collect-genre?genre=k-pop&access_token=${access_token}" class="genre-btn">ğŸ‡°ğŸ‡· K-Pop</a>
        <a href="/collect-genre?genre=pop&access_token=${access_token}" class="genre-btn">ğŸ¤ Pop</a>
        <a href="/collect-genre?genre=hip-hop&access_token=${access_token}" class="genre-btn">ğŸ§ Hip Hop</a>
        <a href="/collect-genre?genre=rock&access_token=${access_token}" class="genre-btn">ğŸ¸ Rock</a>
        <a href="/collect-genre?genre=jazz&access_token=${access_token}" class="genre-btn">ğŸ· Jazz</a>
        <a href="/collect-genre?genre=classical&access_token=${access_token}" class="genre-btn">ğŸ» Classical</a>
        <a href="/collect-genre?genre=edm&access_token=${access_token}" class="genre-btn">ğŸ›ï¸ EDM</a>
        <a href="/collect-genre?genre=r-n-b&access_token=${access_token}" class="genre-btn">ğŸ’¿ R&B</a>
        <a href="/collect-genre?genre=indie&access_token=${access_token}" class="genre-btn">ğŸ¹ Indie</a>
      </div>
      <a href="/dashboard?access_token=${access_token}">â† ëŒ€ì‹œë³´ë“œë¡œ</a>
    </body>
    </html>
  `);
});

app.get('/collect-genre', async (req, res) => {
  const access_token = req.query.access_token;
  const genre = req.query.genre;

  console.log(`\nğŸµ ${genre} ìˆ˜ì§‘ ì‹œì‘...`);

  try {
    const searchResponse = await axios.get(
      `https://api.spotify.com/v1/search?q=genre:${genre}&type=track&limit=50`,
      { headers: { 'Authorization': 'Bearer ' + access_token } }
    );

    const tracks = searchResponse.data.tracks.items;
    let savedCount = 0;
    let audioSuccessCount = 0;

    for (const track of tracks) {
      try {
        await saveTrack(track);

        const audioResponse = await axios.get(
          `https://api.spotify.com/v1/audio-features/${track.id}`,
          { headers: { 'Authorization': 'Bearer ' + access_token } }
        );
        
        if (audioResponse.data && audioResponse.data.id) {
          await saveAudioFeatures(audioResponse.data);
          const tags = generateTags(audioResponse.data);
          tags.push(`ì¥ë¥´: ${genre}`);
          await saveTags(track.id, tags);
          console.log(`  âœ… [${savedCount + 1}/${tracks.length}] ${track.name} (íƒœê·¸: ${tags.length}ê°œ)`);
          audioSuccessCount++;
        } else {
          console.log(`  âš ï¸ [${savedCount + 1}/${tracks.length}] ${track.name} (Audio Features ì—†ìŒ)`);
        }

        savedCount++;
      } catch (err) {
        console.error(`  âŒ ${track.name}: ${err.message}`);
      }

      await new Promise(resolve => setTimeout(resolve, 150));
    }

    console.log(`\nâœ… ì™„ë£Œ: ê³¡ ${savedCount}ê°œ, íƒœê·¸ ${audioSuccessCount}ê°œ\n`);

    res.send(`
      <!DOCTYPE html>
      <html>
      <head><meta charset="UTF-8"><title>${genre} ì™„ë£Œ</title></head>
      <body style="font-family: Arial; max-width: 900px; margin: 50px auto; padding: 20px;">
        <h1>âœ… ${genre} ì¥ë¥´ ìˆ˜ì§‘ ì™„ë£Œ!</h1>
        <p>ì´ ${savedCount}ê°œ ì €ì¥, íƒœê·¸ ${audioSuccessCount}ê°œ ìƒì„±</p>
        <h2>ì €ì¥ëœ ê³¡ (ì¼ë¶€):</h2>
        <ul>${tracks.slice(0, 20).map(t => `<li>${t.name} - ${t.artists[0].name}</li>`).join('')}</ul>
        <a href="/collect-by-genres?access_token=${access_token}">ë‹¤ë¥¸ ì¥ë¥´</a> | 
        <a href="/debug-tags?access_token=${access_token}">ğŸ” ë””ë²„ê·¸</a> |
        <a href="/view-db?access_token=${access_token}">ğŸ“Š DB ì¡°íšŒ</a>
      </body>
      </html>
    `);

  } catch (error) {
    console.error(`âŒ ${genre} ì‹¤íŒ¨:`, error.message);
    res.send(`<h1>âŒ ${genre} ì‹¤íŒ¨</h1><p>${error.message}</p>`);
  }
});
