// ==================== 4. SoundStats API (soundstats.js) ====================
// SoundStatsì—ì„œ Audio Features ê°€ì ¸ì˜¤ê¸°

const axios = require('axios');
const config = require('./1_config');
const { sleep } = require('./2_utils');

async function getTrackWithFeatures(spotifyTrackId, maxRetries = 3) {
  let retryCount = 0;
  
  console.log(`   ğŸ“¡ SoundStats ìš”ì²­ ì¤‘... (Track ID: ${spotifyTrackId})`);
  
  while (retryCount < maxRetries) {
    try {
      console.log(`   ğŸ“¡ ì‹œë„ ${retryCount + 1}/${maxRetries}`);
      
      const response = await axios.get(
        `${config.SOUNDSTAT_BASE_URL}/track/${spotifyTrackId}`,
        {
          headers: {
            'accept': 'application/json',
            'x-api-key': config.SOUNDSTAT_API_KEY
          },
          timeout: 25000,
          validateStatus: function(status) {
            return status < 600;
          }
        }
      );

      console.log(`   ğŸ“¡ ìƒíƒœ ì½”ë“œ: ${response.status}`);

      // 202: ë¶„ì„ ì§„í–‰ ì¤‘
      if (response.status === 202) {
        if (retryCount < 2) {
          console.log(`   â³ ë¶„ì„ ì§„í–‰ ì¤‘... 10ì´ˆ ëŒ€ê¸° (${retryCount + 1}/2)`);
          await sleep(10000);
          retryCount++;
          continue;
        } else {
          console.log(`   â±ï¸ ë¶„ì„ íƒ€ì„ì•„ì›ƒ - ìŠ¤í‚µ`);
          return null;
        }
      }
      
      // 200: ì„±ê³µ
      if (response.status === 200) {
        const trackData = response.data;
        
        console.log(`   ğŸ“‹ ì‘ë‹µ í‚¤:`, Object.keys(trackData));
        
        if (trackData && trackData.features && Object.keys(trackData.features).length > 0) {
          console.log(`   âœ… Audio Features íšë“ ì„±ê³µ`);
          return trackData;
        } else {
          console.log(`   âš ï¸ Audio features ì—†ìŒ`);
          return null;
        }
      }
      
      // 404: ê³¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ
      if (response.status === 404) {
        console.log(`   âŒ 404 - SoundStatsì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
        return null;
      }
      
      // 429: Rate limit
      if (response.status === 429) {
        console.log(`   â±ï¸ 429 - Rate limit. 45ì´ˆ ëŒ€ê¸°...`);
        await sleep(45000);
        retryCount++;
        continue;
      }
      
      // 500: ì„œë²„ ì—ëŸ¬
      if (response.status === 500) {
        console.log(`   âŒ 500 - SoundStats ì„œë²„ ì—ëŸ¬`);
        return null;
      }
      
      console.log(`   âš ï¸ ì˜ˆìƒì¹˜ ëª»í•œ ìƒíƒœ: ${response.status}`);
      return null;

    } catch (error) {
      console.error(`   âŒ ìš”ì²­ ì‹¤íŒ¨:`, error.message);
      console.error(`   ì—ëŸ¬ ì½”ë“œ:`, error.code);
      
      if (error.code === 'ECONNABORTED') {
        console.log(`   â±ï¸ íƒ€ì„ì•„ì›ƒ - ìŠ¤í‚µ`);
        return null;
      }
      
      if (error.code === 'ENOTFOUND') {
        console.log(`   âŒ DNS ì—ëŸ¬ - ìŠ¤í‚µ`);
        return null;
      }
      
      return null;
    }
  }
  
  return null;
}

module.exports = {
  getTrackWithFeatures
};
