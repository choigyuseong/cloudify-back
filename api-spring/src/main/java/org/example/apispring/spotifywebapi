# Spotify API ì„¤ì •
spotify.client-id=YOUR_SPOTIFY_CLIENT_ID
spotify.client-secret=YOUR_SPOTIFY_CLIENT_SECRET

# ì„œë²„ ì„¤ì •
server.port=8080

# ë¡œê¹…
logging.level.org.example=DEBUG


package org.example.apispring.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.reactive.function.client.WebClient;

@Configuration
public class WebClientConfig {
    
    @Bean
    public WebClient.Builder webClientBuilder() {
        return WebClient.builder();
    }
}


package org.example.apispring.service;

import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;
import org.springframework.web.reactive.function.client.WebClient;

import java.time.Instant;
import java.util.Base64;
import java.util.Map;

@Service
@Slf4j
public class SpotifyAuthService {
    
    @Value("${spotify.client-id}")
    private String clientId;
    
    @Value("${spotify.client-secret}")
    private String clientSecret;
    
    private final WebClient webClient;
    
    private String accessToken;
    private Instant tokenExpiry;
    
    public SpotifyAuthService(WebClient.Builder webClientBuilder) {
        this.webClient = webClientBuilder
                .baseUrl("https://accounts.spotify.com")
                .build();
    }
    
    /**
     * Access Token ë°œê¸‰ (ìë™ ê°±ì‹  í¬í•¨)
     */
    public String getAccessToken() {
        // í† í°ì´ ì—†ê±°ë‚˜ ë§Œë£Œ 5ë¶„ ì „ì´ë©´ ê°±ì‹ 
        if (accessToken == null || 
            tokenExpiry == null || 
            Instant.now().isAfter(tokenExpiry.minusSeconds(300))) {
            
            refreshAccessToken();
        }
        
        return accessToken;
    }
    
    /**
     * Access Token ê°±ì‹ 
     */
    private void refreshAccessToken() {
        log.info("ğŸ”„ Spotify Access Token ê°±ì‹  ì¤‘...");
        
        try {
            // Basic Auth ì¸ì½”ë”©
            String auth = clientId + ":" + clientSecret;
            String encodedAuth = Base64.getEncoder()
                    .encodeToString(auth.getBytes());
            
            // Request Body
            MultiValueMap<String, String> formData = new LinkedMultiValueMap<>();
            formData.add("grant_type", "client_credentials");
            
            // API í˜¸ì¶œ
            Map<String, Object> response = webClient.post()
                    .uri("/api/token")
                    .header("Authorization", "Basic " + encodedAuth)
                    .header("Content-Type", "application/x-www-form-urlencoded")
                    .bodyValue(formData)
                    .retrieve()
                    .bodyToMono(Map.class)
                    .block();
            
            // í† í° ì €ì¥
            this.accessToken = (String) response.get("access_token");
            Integer expiresIn = (Integer) response.get("expires_in");
            this.tokenExpiry = Instant.now().plusSeconds(expiresIn);
            
            log.info("âœ… Access Token ë°œê¸‰ ì™„ë£Œ (ë§Œë£Œ: {})", tokenExpiry);
            
        } catch (Exception e) {
            log.error("âŒ Access Token ë°œê¸‰ ì‹¤íŒ¨", e);
            throw new RuntimeException("Spotify ì¸ì¦ ì‹¤íŒ¨", e);
        }
    }
}


package org.example.apispring.service;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.example.apispring.dto.SpotifyTrack;
import org.springframework.stereotype.Service;
import org.springframework.web.reactive.function.client.WebClient;
import org.springframework.web.util.UriComponentsBuilder;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;

@Service
@RequiredArgsConstructor
@Slf4j
public class SpotifySearchService {
    
    private final SpotifyAuthService authService;
    private final WebClient.Builder webClientBuilder;
    
    private WebClient getSpotifyClient() {
        return webClientBuilder
                .baseUrl("https://api.spotify.com/v1")
                .build();
    }
    
    /**
     * íŠ¸ë™ ê²€ìƒ‰
     */
    public List<SpotifyTrack> searchTracks(String query, int limit) {
        log.info("ğŸ” Spotify ê²€ìƒ‰: {}", query);
        
        String token = authService.getAccessToken();
        
        String uri = UriComponentsBuilder.fromPath("/search")
                .queryParam("q", query)
                .queryParam("type", "track")
                .queryParam("market", "KR")
                .queryParam("limit", limit)
                .build()
                .toUriString();
        
        try {
            Map<String, Object> response = getSpotifyClient()
                    .get()
                    .uri(uri)
                    .header("Authorization", "Bearer " + token)
                    .retrieve()
                    .bodyToMono(Map.class)
                    .block();
            
            // íŒŒì‹±
            Map<String, Object> tracks = (Map<String, Object>) response.get("tracks");
            List<Map<String, Object>> items = (List<Map<String, Object>>) tracks.get("items");
            
            List<SpotifyTrack> result = new ArrayList<>();
            for (Map<String, Object> item : items) {
                SpotifyTrack track = parseTrack(item);
                result.add(track);
            }
            
            log.info("âœ… ê²€ìƒ‰ ì™„ë£Œ: {}ê°œ", result.size());
            return result;
            
        } catch (Exception e) {
            log.error("âŒ ê²€ìƒ‰ ì‹¤íŒ¨", e);
            throw new RuntimeException("Spotify ê²€ìƒ‰ ì‹¤íŒ¨", e);
        }
    }
    
    /**
     * ë‹¨ì¼ íŠ¸ë™ ì¡°íšŒ
     */
    public SpotifyTrack getTrack(String trackId) {
        log.info("ğŸµ íŠ¸ë™ ì¡°íšŒ: {}", trackId);
        
        String token = authService.getAccessToken();
        
        try {
            Map<String, Object> response = getSpotifyClient()
                    .get()
                    .uri("/tracks/" + trackId)
                    .header("Authorization", "Bearer " + token)
                    .retrieve()
                    .bodyToMono(Map.class)
                    .block();
            
            return parseTrack(response);
            
        } catch (Exception e) {
            log.error("âŒ íŠ¸ë™ ì¡°íšŒ ì‹¤íŒ¨", e);
            throw new RuntimeException("íŠ¸ë™ ì¡°íšŒ ì‹¤íŒ¨", e);
        }
    }
    
    /**
     * JSON â†’ SpotifyTrack ë³€í™˜
     */
    private SpotifyTrack parseTrack(Map<String, Object> item) {
        SpotifyTrack track = new SpotifyTrack();
        
        track.setId((String) item.get("id"));
        track.setName((String) item.get("name"));
        track.setDurationMs((Integer) item.get("duration_ms"));
        track.setPopularity((Integer) item.get("popularity"));
        
        // ì•„í‹°ìŠ¤íŠ¸
        List<Map<String, Object>> artists = (List<Map<String, Object>>) item.get("artists");
        if (!artists.isEmpty()) {
            Map<String, Object> artist = artists.get(0);
            track.setArtistId((String) artist.get("id"));
            track.setArtistName((String) artist.get("name"));
        }
        
        // ì•¨ë²”
        Map<String, Object> album = (Map<String, Object>) item.get("album");
        track.setAlbumName((String) album.get("name"));
        
        return track;
    }
}
