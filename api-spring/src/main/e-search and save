// ==================== ê²€ìƒ‰ & ì €ì¥ ====================

app.get('/search-and-save', (req, res) => {
  const access_token = req.query.access_token;
  res.send(`
    <!DOCTYPE html>
    <html>
    <head><meta charset="UTF-8"><title>ê²€ìƒ‰ & ì €ì¥</title></head>
    <body style="font-family: Arial; max-width: 800px; margin: 50px auto; padding: 20px;">
      <h1>ğŸ” ê²€ìƒ‰ & DB ì €ì¥</h1>
      <form action="/search-save-result" method="GET">
        <input type="hidden" name="access_token" value="${access_token}">
        <input type="text" name="q" placeholder="ê³¡ ì´ë¦„ ì…ë ¥" style="width: 60%; padding: 10px; font-size: 16px;" required>
        <button type="submit" style="padding: 10px 20px; font-size: 16px; background: #1DB954; color: white; border: none; cursor: pointer;">ê²€ìƒ‰ & ì €ì¥</button>
      </form>
      <br>
      <a href="/dashboard?access_token=${access_token}" style="color: #1DB954;">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
    </body>
    </html>
  `);
});

app.get('/search-save-result', async (req, res) => {
  const access_token = req.query.access_token;
  const query = req.query.q;

  try {
    const searchResponse = await axios.get(
      `https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=5`,
      { headers: { 'Authorization': 'Bearer ' + access_token } }
    );

    const tracks = searchResponse.data.tracks.items;
    let successCount = 0;

    for (const track of tracks) {
      await saveTrack(track);

      try {
        const audioResponse = await axios.get(
          `https://api.spotify.com/v1/audio-features/${track.id}`,
          { headers: { 'Authorization': 'Bearer ' + access_token } }
        );
        
        if (audioResponse.data && audioResponse.data.id) {
          await saveAudioFeatures(audioResponse.data);
          const tags = generateTags(audioResponse.data);
          await saveTags(track.id, tags);
          console.log(`âœ… ${track.name} - íƒœê·¸ ${tags.length}ê°œ ìƒì„±`);
          successCount++;
        }
      } catch (err) {
        console.error(`âš ï¸ Audio features ì‹¤íŒ¨: ${track.name}`);
      }

      await new Promise(resolve => setTimeout(resolve, 150));
    }

    res.send(`
      <!DOCTYPE html>
      <html>
      <head><meta charset="UTF-8"><title>ì €ì¥ ì™„ë£Œ</title></head>
      <body style="font-family: Arial; max-width: 800px; margin: 50px auto; padding: 20px;">
        <h1>âœ… ${tracks.length}ê°œ íŠ¸ë™ ì €ì¥ ì™„ë£Œ!</h1>
        <p>íƒœê·¸ ìƒì„±: ${successCount}ê°œ</p>
        <ul>
          ${tracks.map(t => `<li>${t.name} - ${t.artists[0].name}</li>`).join('')}
        </ul>
        <a href="/search-and-save?access_token=${access_token}">ë‹¤ì‹œ ê²€ìƒ‰</a> | 
        <a href="/view-db?access_token=${access_token}">ğŸ“Š DB ì¡°íšŒ</a>
      </body>
      </html>
    `);

  } catch (error) {
    console.error('âŒ ê²€ìƒ‰ ì‹¤íŒ¨:', error.message);
    res.send(`
      <h1>âŒ ê²€ìƒ‰ ì‹¤íŒ¨</h1>
      <p>${error.message}</p>
      <a href="/search-and-save?access_token=${access_token}">â† ëŒì•„ê°€ê¸°</a>
    `);
  }
});
