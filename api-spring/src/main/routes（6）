// ==================== 6. ì›¹ ë¼ìš°íŠ¸ (routes.js) ====================
// ëª¨ë“  ì›¹ ë¼ìš°íŠ¸

const express = require('express');
const { sleep } = require('./2_utils');
const { searchGenreTracks, searchAndGetTrack } = require('./3_spotify');
const { getTrackWithFeatures } = require('./4_soundstats');
const { saveTrackComplete, getAllTracks, getStats } = require('./5_database');

const router = express.Router();

// ëŒ€ì‹œë³´ë“œ
router.get('/', (req, res) => res.redirect('/dashboard'));

router.get('/dashboard', (req, res) => {
  res.send(`
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>SoundStats Dashboard</title>
      <style>
        body { font-family: Arial; max-width: 1200px; margin: 50px auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #6366f1; }
        .menu a { display: inline-block; margin: 10px; padding: 15px 25px; background: #6366f1; color: white; text-decoration: none; border-radius: 5px; }
        .menu a:hover { background: #4f46e5; }
        .success { background: #d1fae5; padding: 15px; border-radius: 5px; margin: 20px 0; color: #065f46; }
        .info { background: #e0e7ff; padding: 15px; border-radius: 5px; margin: 20px 0; }
      </style>
    </head>
    <body>
      <div class="container">
        <h1>ğŸµ SoundStats Music Database</h1>
        <div class="success"><strong>âœ… AWS RDS ì—°ê²°ë¨!</strong></div>
        <div class="info">
          <strong>âœ¨ ê¸°ëŠ¥:</strong>
          <ul>
            <li>Spotify: ê°œì„ ëœ ì¥ë¥´ë³„ ê²€ìƒ‰</li>
            <li>SoundStats: Audio Features ë¶„ì„</li>
            <li>AWS RDS PostgreSQL: ë°ì´í„° ì €ì¥</li>
            <li>ìë™ íƒœê·¸ ìƒì„±</li>
          </ul>
        </div>
        <div class="menu">
          <a href="/test">ğŸ§ª í…ŒìŠ¤íŠ¸</a>
          <a href="/search">ğŸ” ê²€ìƒ‰</a>
          <a href="/bulk-genre">ğŸ“š ì¥ë¥´ë³„</a>
          <a href="/view-db">ğŸ“Š DB ì¡°íšŒ</a>
          <a href="/stats">ğŸ“ˆ í†µê³„</a>
        </div>
      </div>
    </body>
    </html>
  `);
});

// í…ŒìŠ¤íŠ¸
router.get('/test', async (req, res) => {
  try {
    console.log('\n========================================');
    console.log('ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹œì‘');
    console.log('========================================\n');
    
    const candidates = await searchAndGetTrack('Blinding Lights The Weeknd');
    if (!candidates || candidates.length === 0) throw new Error('ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ');
    
    const track = candidates[0];
    const trackWithFeatures = await getTrackWithFeatures(track.id);
    if (!trackWithFeatures) throw new Error('SoundStats ë°ì´í„° ì—†ìŒ');
    
    const completeTrack = { ...track, ...trackWithFeatures };
    const result = await saveTrackComplete(completeTrack);
    
    if (result.success) {
      res.send(`
        <h1 style="color: #6366f1;">âœ… í…ŒìŠ¤íŠ¸ ì„±ê³µ!</h1>
        <h2>${track.name} - ${track.artists?.join(', ')}</h2>
        <p><strong>í…œí¬:</strong> ${trackWithFeatures.features?.tempo ? Math.round(trackWithFeatures.features.tempo) + ' BPM' : 'N/A'}</p>
        <a href="/view-db">ğŸ“Š DB ì¡°íšŒ</a> | <a href="/dashboard">â† ëŒ€ì‹œë³´ë“œ</a>
      `);
    } else {
      throw new Error(result.error);
    }
  } catch (error) {
    console.error('\nâŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error.message);
    console.error('ìŠ¤íƒ:', error.stack);
    res.send(`<h1>âŒ ì‹¤íŒ¨</h1><p>${error.message}</p><a href="/dashboard">â† ëŒì•„ê°€ê¸°</a>`);
  }
});

// ê²€ìƒ‰
router.get('/search', (req, res) => {
  res.send(`
    <h1>ğŸ” ê³¡ ê²€ìƒ‰</h1>
    <form action="/search-result" method="GET">
      <input type="text" name="q" placeholder="ì˜ˆ: Dynamite BTS" required>
      <button type="submit">ê²€ìƒ‰</button>
    </form>
  `);
});

router.get('/search-result', async (req, res) => {
  try {
    const query = req.query.q;
    console.log(`\nğŸ” ê²€ìƒ‰: ${query}\n`);
    
    const candidates = await searchAndGetTrack(query);
    if (!candidates || candidates.length === 0) {
      return res.send(`<h1>âŒ ê²°ê³¼ ì—†ìŒ</h1><p>"${query}"ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p><a href="/search">â† ë‹¤ì‹œ</a>`);
    }
    
    const track = candidates[0];
    const trackWithFeatures = await getTrackWithFeatures(track.id);
    if (!trackWithFeatures) {
      return res.send(`<h1>âš ï¸ SoundStats ë°ì´í„° ì—†ìŒ</h1><p>ë‹¤ë¥¸ ê³¡ì„ ì‹œë„í•´ë³´ì„¸ìš”.</p><a href="/search">â† ë‹¤ì‹œ</a>`);
    }
    
    const completeTrack = { ...track, ...trackWithFeatures };
    const result = await saveTrackComplete(completeTrack);
    
    res.send(`
      <h1>${result.success ? 'âœ… ì €ì¥ ì™„ë£Œ' : 'âŒ ì €ì¥ ì‹¤íŒ¨'}</h1>
      <h2>${track.name}</h2>
      <a href="/search">ë‹¤ì‹œ ê²€ìƒ‰</a> | <a href="/view-db">ğŸ“Š DB ì¡°íšŒ</a>
    `);
  } catch (error) {
    console.error('âŒ ê²€ìƒ‰ ì‹¤íŒ¨:', error.message);
    res.send(`<h1>âŒ ì‹¤íŒ¨</h1><p>${error.message}</p><a href="/search">â† ë‹¤ì‹œ</a>`);
  }
});

// ì¥ë¥´ë³„ ì¼ê´„ ì¶”ê°€
router.get('/bulk-genre', (req, res) => {
  res.send(`
    <h1>ğŸ“š ì¥ë¥´ë³„ ì¼ê´„ ì¶”ê°€</h1>
    <form action="/bulk-import" method="POST">
      <input type="text" name="genre" placeholder="pop, rock, jazz..." required>
      <button type="submit">20ê³¡ ê°€ì ¸ì˜¤ê¸°</button>
    </form>
  `);
});

router.post('/bulk-import', async (req, res) => {
  const genre = req.body.genre?.trim();
  
  if (!genre) {
    return res.status(400).send('âŒ ì¥ë¥´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
  }

  res.writeHead(200, {
    'Content-Type': 'text/html; charset=utf-8',
    'Transfer-Encoding': 'chunked'
  });

  res.write(`<h1>ğŸ“š ${genre} ì¶”ê°€ ì¤‘...</h1><pre>`);

  try {
    console.log(`\nğŸµ "${genre}" ì¥ë¥´ ê²€ìƒ‰ ì‹œì‘\n`);
    
    const spotifyTracks = await searchGenreTracks(genre, 20);
    
    if (spotifyTracks.length === 0) {
      res.write('âŒ ê²€ìƒ‰ëœ ê³¡ì´ ì—†ìŠµë‹ˆë‹¤\n');
      res.end('</pre>');
      return;
    }

    res.write(`âœ… ${spotifyTracks.length}ê°œ ê³¡ ê²€ìƒ‰ ì™„ë£Œ\n\n`);

    let successCount = 0;
    let failCount = 0;

    for (let i = 0; i < spotifyTracks.length; i++) {
      const track = spotifyTracks[i];
      const progress = `[${i + 1}/${spotifyTracks.length}]`;
      
      res.write(`${progress} ${track.name}... `);

      try {
        const trackWithFeatures = await getTrackWithFeatures(track.id, 2);
        
        if (trackWithFeatures && trackWithFeatures.features) {
          const completeTrack = { ...track, ...trackWithFeatures };
          const result = await saveTrackComplete(completeTrack);
          
          if (result.success) {
            successCount++;
            res.write('âœ…\n');
          } else {
            failCount++;
            res.write('âŒ\n');
          }
        } else {
          failCount++;
          res.write('â­ï¸\n');
        }
      } catch (error) {
        failCount++;
        res.write(`âŒ\n`);
      }
      
      await sleep(500);
    }

    res.write(`\nì™„ë£Œ: ì„±ê³µ ${successCount}ê³¡, ì‹¤íŒ¨ ${failCount}ê³¡\n`);
    res.end('</pre>');
    
  } catch (error) {
    console.error('âŒ ì˜¤ë¥˜:', error.message);
    res.write(`âŒ ì˜¤ë¥˜: ${error.message}\n`);
    res.end('</pre>');
  }
});

// DB ì¡°íšŒ
router.get('/view-db', async (req, res) => {
  try {
    const tracks = await getAllTracks();

    res.send(`
      <!DOCTYPE html>
      <html>
      <head><meta charset="UTF-8"><title>DB ì¡°íšŒ</title>
      <style>
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #6366f1; color: white; }
      </style>
      </head>
      <body>
        <h1>ğŸ“Š ì €ì¥ëœ ê³¡ (${tracks.length}ê°œ)</h1>
        <table>
          <tr>
            <th>#</th><th>ê³¡ëª…</th><th>ì•„í‹°ìŠ¤íŠ¸</th><th>ì¥ë¥´</th><th>í…œí¬</th><th>ì—ë„ˆì§€</th>
          </tr>
          ${tracks.map((t, i) => `
            <tr>
              <td>${i + 1}</td>
              <td>${t.name}</td>
              <td>${t.artists?.join(', ') || '-'}</td>
              <td>${t.genre || '-'}</td>
              <td>${t.tempo ? Math.round(t.tempo) : '-'}</td>
              <td>${t.energy ? (t.energy * 100).toFixed(0) + '%' : '-'}</td>
            </tr>
          `).join('')}
        </table>
        <br><a href="/dashboard">â† ëŒ€ì‹œë³´ë“œ</a>
      </body>
      </html>
    `);
  } catch (error) {
    res.send('DB ì¡°íšŒ ì‹¤íŒ¨: ' + error.message);
  }
});

// í†µê³„
router.get('/stats', async (req, res) => {
  try {
    const stats = await getStats();

    res.send(`
      <h1>ğŸ“ˆ í†µê³„</h1>
      <p><strong>ì´ ê³¡:</strong> ${stats.total}</p>
      <p><strong>ì¥ë¥´ ì¢…ë¥˜:</strong> ${stats.genre_count}</p>
      <p><strong>í‰ê·  í…œí¬:</strong> ${stats.avg_tempo ? Math.round(stats.avg_tempo) : 0} BPM</p>
      <p><strong>í‰ê·  ì—ë„ˆì§€:</strong> ${stats.avg_energy ? (stats.avg_energy * 100).toFixed(0) + '%' : '0%'}</p>
      <a href="/dashboard">â† ëŒ€ì‹œë³´ë“œ</a>
    `);
  } catch (error) {
    res.send('í†µê³„ ì‹¤íŒ¨: ' + error.message);
  }
});

module.exports = router;
