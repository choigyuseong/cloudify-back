// ==================== 7. ë©”ì¸ ì„œë²„ (app.js) ====================
// ë¶„ë¦¬ëœ ëª¨ë“ˆë“¤ì„ í†µí•©í•˜ëŠ” ë©”ì¸ íŒŒì¼

const express = require('express');
const session = require('express-session');
const config = require('./1_config');
const { initializeTables } = require('./5_database');
const routes = require('./6_routes');

const app = express();
const PORT = 8888;

// ==================== ì „ì—­ ì—ëŸ¬ í•¸ë“¤ë§ ====================
process.on('uncaughtException', (err) => {
  console.error('\nâŒâŒâŒ UNCAUGHT EXCEPTION âŒâŒâŒ');
  console.error('ì—ëŸ¬ ë©”ì‹œì§€:', err.message);
  console.error('ìŠ¤íƒ:', err.stack);
  console.error('íƒ€ìž…:', err.constructor.name);
  console.error('ë°œìƒ ì‹œê°„:', new Date().toISOString());
  console.error('==========================================\n');
});

process.on('unhandledRejection', (reason, promise) => {
  console.error('\nâŒâŒâŒ UNHANDLED PROMISE REJECTION âŒâŒâŒ');
  console.error('Promise:', promise);
  console.error('ì´ìœ :', reason);
  if (reason instanceof Error) {
    console.error('ì—ëŸ¬ ë©”ì‹œì§€:', reason.message);
    console.error('ìŠ¤íƒ:', reason.stack);
  }
  console.error('ë°œìƒ ì‹œê°„:', new Date().toISOString());
  console.error('==========================================\n');
});

// ==================== ë¯¸ë“¤ì›¨ì–´ ====================
app.use(session({
  secret: 'soundstat-secret-key-12345',
  resave: false,
  saveUninitialized: true,
  cookie: { maxAge: 3600000 }
}));

app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// ==================== ë¼ìš°íŠ¸ ì ìš© ====================
app.use('/', routes);

// ==================== ì´ˆê¸°í™” ====================
async function startup() {
  try {
    console.log('\n========================================');
    console.log('ðŸš€ SoundStats ì„œë²„ ì‹œìž‘');
    console.log('========================================\n');
    
    // DB í…Œì´ë¸” ì´ˆê¸°í™”
    await initializeTables();
    
    // ì„œë²„ ì‹œìž‘
    app.listen(PORT, () => {
      console.log(`\nðŸŽµ ì„œë²„ ì‹¤í–‰: http://localhost:${PORT}`);
      console.log(`ðŸ“ ëŒ€ì‹œë³´ë“œ: http://localhost:${PORT}/dashboard`);
      console.log(`ðŸ“š ìž¥ë¥´ë³„ ì¼ê´„ ì¶”ê°€: http://localhost:${PORT}/bulk-genre\n`);
    });
    
  } catch (error) {
    console.error('âŒ ì´ˆê¸°í™” ì‹¤íŒ¨:', error.message);
    console.error('ìŠ¤íƒ:', error.stack);
    process.exit(1);
  }
}

startup();

// ==================== ì¢…ë£Œ ì²˜ë¦¬ ====================
process.on('SIGINT', async () => {
  console.log('\n\nðŸ›‘ ì„œë²„ ì¢…ë£Œ ì¤‘...');
  await config.pool.end();
  console.log('âœ… DB ì—°ê²° ì¢…ë£Œ');
  process.exit(0);
});
